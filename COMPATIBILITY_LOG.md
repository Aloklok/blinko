# Monterey (Safari 15) 兼容性改造日志

本文档记录了本 Fork 仓库相对于官方上游仓库 (`blinkospace/blinko`) 所做的关键调整，旨在解决 macOS Monterey (12.x) / iOS 15 下的兼容性问题。

## 核心调整概览

| 调整领域 | 方案 | 类型 | 影响评估 |
| :--- | :--- | :--- | :--- |
| **CSS 样式** | `postcss-preset-env` | ✅ 无损 | 自动降级，视觉效果一致 |
| **JS API** | NPM Polyfills | ✅ 无损 | 补齐标准 API，无逻辑副作用 |
| **JS 正则** | `vite-plugin-safari-transform` | ⚠️ 有损 | 牺牲正则精确度以换取不崩溃 |
| **构建目标** | Target `es2020` | ⚪️ 微损 | 包体积轻微增加，理论性能无感 |
| **图标提取** | 自动化扫描 + Turbo 管道 | ✅ 无损 | 全自动同步，解决动态图标缺失 |
| **交互优化** | AI 润色集成 | ✅ 无损 | 复用现有编辑器，增加快捷入口 |

---

## 1. CSS 样式 (无损改造)

### 🔴 原版问题
官方使用了 `color-mix(in srgb, ...)` 等现代 CSS 语法。
在 Safari 15 下，浏览器无法解析此函数，导致：
*   所有用到该颜色的背景变成透明/白色。
*   文字颜色失效，某些按钮不可见。

### 🟢 我们的方案
*   **工具**: 引入 `postcss-preset-env`。
*   **原理**: 在构建打包时，自动计算出 `color-mix` 的最终颜色值，并生成 `rgba()` 格式的 Fallback 代码。
*   **差异**:
    ```css
    /* 源码 (不变) */
    background: color-mix(in srgb, var(--primary), transparent 90%);
    
    /* 构建产物 (自动生成) */
    background: rgba(var(--primary-rgb), 0.1); /* Safari 15 用这个 */
    background: color-mix(in srgb, var(--primary), transparent 90%); /* 现代浏览器用这个 */
    ```
*   **结论**: **完全无损**。在旧设备上看到的颜色可能与新设备有肉眼不可察觉的微小差异（计算精度问题），但不影响 UI。

---

## 2. JS API 运行时 (无损改造)

### 🔴 原版问题
应用启动时直接白屏或操作时崩溃，控制台报错：
*   `ReferenceError: Can't find variable: AbortSignal` (specifically `timeout` method)
*   `requestIdleCallback is not a function`

### 🟢 我们的方案
*   **工具**: 引入标准 Polyfill 包 `abort-controller-polyfill` 和 `requestidlecallback-polyfill`。
*   **原理**: 在 `main.tsx` 最顶层检测环境，如果浏览器缺失这些 API，则自动打补丁。
*   **差异**: 仅在全局对象上挂载了缺失的方法，完全符合 W3C 标准规范。
*   **结论**: **完全无损**。

---

## 3. JS 正则表达式 (有损改造)

### 🔴 原版问题
这是最棘手的问题。Safari 15 的 JS 引擎 (WebKit 605) **不支持** 正则 Lookbehind (反向断言 `(?<=...)`)。
一旦 JS 文件中包含这种语法（哪怕不执行），解析器也会直接抛出 `SyntaxError`，导致整个应用白屏。
主要来源是第三方库：`vditor` (Markdown编辑器), `prismjs` (代码高亮)。

### 🟢 我们的方案
*   **工具**: 自研 Vite 插件 `vite-plugin-safari-transform`。
*   **原理**: 在构建的最后阶段 (`renderChunk`)，暴力扫描所有 JS 代码，将 Lookbehind 语法移除或替换。
*   **具体行为**:
    *   `(?<=@)\w+`  -> 转换为 -> `(?:@)\w+` (非捕获组)
    *   `(?<!@)\w+`  -> 转换为 -> `(?:@)\w+`
*   **差异 (有损点)**:
    *   **原意**: "匹配前面是 @ 的字符，但不包含 @ 本身"。
    *   **现意**: "匹配 @ 及其后面的字符" (因为变成了普通非捕获组)。
*   **潜在影响**:
    *   在 Markdown 编辑或代码高亮时，某些特殊的语法块（如嵌套的括号、特定的代码注释）可能**高亮颜色范围不对**。
    *   例如：原本只该高亮函数名的，现在可能连前面的空格也一起高亮了。
*   **结论**: **有损，但在可接受范围内**。
    *   **User Impact**: 仅仅是代码高亮稍微有点瑕疵，而不是整个 App 打不开。这是工程上的权衡 (Trade-off)。

---

## 4. 构建环境

### 🔴 原版配置
*   `target`: 默认为 `modules` (通常是近年来主流浏览器)。

### 🟢 我们的方案
*   `target`: 显式指定为 `es2020`。
*   **差异**: 编译器会将某些新语法（如 `BigInt` 的某些用法，或 Optional Chaining 的边缘情况）编译成更繁琐的 ES5/ES6 代码。
*   **结论**: 包体积可能会增加几 KB，**功能无损**。

---

## 5. 个性化交互 (DIY 定制)

此部分为满足特定用户体验而做的**非标准化修改**，从 `blinko-64-dmg` 的 `disable-interactions.patch` 移植而来。

| 功能 | 变更内容 | 原因 |
| :--- | :--- | :--- |
| **禁止滑动** | 移除了移动端的左右滑动交互 (`react-swipeable`) | 旧设备触摸板/鼠标容易误触左滑删除 |
| **禁止拖拽** | 禁用了看板的拖拽重排功能 (`dnd-kit`) | 避免误操作，保持布局静态 |
| **精简按钮** | 隐藏了卡片头部的 "Share" 和 "History" 按钮 | 减少视觉干扰，功能极简主义 |
| **字体颜色** | 强制 Light Mode 下正文颜色为 `#323232` | 提升文字对比度和可读性 |
| **交互动画** | 移除了卡片 Hover 时的上浮位移 | 减少页面抖动，提升稳重感 |
| **UI 洁癖** | 隐藏了 **Trash Icon** (垃圾桶) | 极致极简，防止误删 |
| **空间呼吸** | 卡片 Header 底部间距增加 (`mb-3`) | 优化视觉层次，避免信息拥挤 |

## 6. Flomo 风格排版 (Style Overhaul)

为了追求极致的中文阅读体验，我们引入了一套类 Flomo 的排版规范 (`globals.css`)：

*   **排版几何**:
    *   **行高**: 锁定 `1.8` (原 1.5)，增加行间呼吸感。
    *   **字号**: 锁定 `15px` (原 14/16px)，移动端阅读的最佳平衡点。
    *   **两端对齐**: 启用 `text-justify: inter-character`，让块状文本更整齐。
    *   **段落重置**: 移除 `p` 标签的默认 margin，消除割裂感。
*   **组件微调**:
    *   **标签 (Tag)**: 圆角由 7px 收缩为 4px，视觉更硬朗干练。
    *   **数字**: 启用 `proportional-nums` (比例数字)，让时间戳更精致。

## 7. 移动端编辑器重构 (Mobile Editor Overhaul)

针对 iPhone SE 等小屏设备进行了深度的交互反馈与布局重构，确保极致的触控体验。

### 7.1 双层工具栏架构
*   **Top Row**: 复用 Vditor 原生工具栏，负责基础格式（加粗、列表、Emoji），确保 100% 的状态同步稳定性。
*   **Bottom Row**: 自定义 React 组件，集成业务逻辑（笔记类型、标签、引用、AI、附件、全屏）。

### 7.2 触控人体工学 (Ergonomics)
*   **超大点击位**: 底部按钮统一采用 **50px** 容器（原 32px 左右），图标放大至 **26px**，极大降低了误触率。
*   **高质感录音按钮**: 采用 `solar:soundwave-bold` 绿色通透图标，移除实心背景以保持视觉灵动感。

### 7.3 全屏高度修正 (Layout Fix)
*   **问题**: 移动端弹出框全屏模式下，编辑器无法自动撑开，导致底部工具栏悬浮在屏幕中间。
*   **方案**: 解耦了全屏类名与顶部工具栏显示状态的依赖关系。强制在 `store.isFullscreen` 为真时应用 `flex-1` 和 `fullscreen-editor` 类。
*   **结论**: 实现了移动端编辑器的“沉浸式”创作体验，内容区自动铺满视口，工具栏强制沉底。

## 8. 构建流深度优化 (Workflow Optimization)

移除了所有非核心的 CI/CD 流程，专注于 "Monterey Intel Mac" 私有化构建与 "Zeabur Docker" 部署。

*   **App Release**:
    *   **删减**: 移除 Windows / Linux / Android / Apple Silicon 构建矩阵。
    *   **锁定**: 仅保留 `macos-15-intel` (x86_64)，直接产出兼容 macOS 12 (Monterey) 的 DMG。
*   **Docker Release**:
    *   **策略**: 保留 `amd64` + `arm64` 双架构构建，确保 Zeabur 等 PaaS 平台的兼容性。
*   **环境净化**:
    *   删除了 `docker-build.yml` (临时)、`translator.yml` 等 5 个冗余工作流文件。

## 9. 卡片交互优化 (BlinkoCard UX)

针对高频操作进行了路径缩短与视觉降噪处理。

### 9.1 下拉菜单重构 (Dropdown Menu)
*   **首行速操作**: 将高频使用的 **[评论]**、**[AI标签]**、**[编辑]** 提权至菜单首行。
*   **水平并列**: 采用图标+微型文本的水平布局 (Flex Row)，显著压缩了菜单的垂直长度。
*   **自动收起**: 优化了点击反馈，点击首行任一图标后自动关闭下拉菜单。

### 9.2 侧边栏折叠 (Sidebar)
*   **区域收纳**: 将 "Statistics" / "Resources" / "Archive" 等低频区域默认折叠。
*   **Show More**: 增加展开/收起切换器，减少侧边栏视觉噪音，聚焦核心笔记功能。

## 10. AI 自动标签去重 (Deduplication)

### 🔴 原版问题
当启用 AI 后处理自动生成标签时，系统会无差别地将建议标签追加到笔记末尾。如果笔记已手动打过相同标签（或多次触发后处理），会导致笔记末尾堆叠大量重复的标签（例如：`#tag1 #tag1 #tag1`），严重影响视觉美观和搜索效率。

### 🟢 我们的方案
在后端 `AiService.postProcessNote` 逻辑中注入了**幂等去重层**：
1.  **加载现状**: 在调用 AI 之前，先提取笔记已有的所有标签名。
2.  **正向过滤**: 对 AI 返回的列表进行清洗，仅保留当前笔记中**尚不存在**的标签。
3.  **上限控制**: 强制限制单次追加的标签数量（当前为 5 个），防止标签爆炸。

### 🔵 兼容性收益
*   **数据纯净**: 彻底杜绝了笔记正文被重复标签污染的问题。
*   **无需干预**: 用户不再需要手动删除 AI 多次触发产生的垃圾数据。

---

## 11. 图标提取系统 (Icon Extraction Automation)

### 🔴 原版问题
官方使用了 Iconify 的动态图标加载。在旧版构建环境或某些离线部署中，由于扫描脚本 `buildIcons.js` 的正则匹配范围过窄（仅限固定属性赋值），导致动态生成的图标（如三元表达式 `collapsed ? 'right' : 'left'`）无法被正确提取至本地 `icons.tsx`，产生 `Local icon not found` 错误。

### 🟢 我们的方案
*   **全量扫描**: 重构 `buildIcons.js` 为健壮的全局扫描机制，能够识别代码中任何位置的 `prefix:name` 图标字符串。
*   **合法性校验**: 引入 `@iconify/json` 本地校验，自动过滤无效匹配。
*   **全链路自动化 (Pipeline)**:
    *   **Turbo 管道**: 在 `turbo.json` 中建立依赖，确保 `build:web` (网页/Docker) 始终自动运行图标构建。
    *   **GitHub Actions**: 补全了客户端自动构建 (`app-release.yml`) 缺失的图标生成步骤。
    *   **本地开发**: 修改根目录 `dev` 脚本，实现“启动即自动扫描更新”。

### 🔵 兼容性收益
*   **稳定性**: 彻底解决了图标缺失警告，确保桌面端产物和 Docker 镜像的图标资产完整。
*   **零维护**: 移除了所有手动补丁清单，实现“一次配置，全自动同步”。

---

## 12. AI 润色功能 (AI Polish Integration)

为了提升笔记的快速优化体验，我们在卡片列表页集成了 AI 润色入口。

*   **功能**: 在卡片 "More" 菜单 (及右键菜单) 中新增 "AI Polish" 选项。
*   **流程优化**:
    *   **静默处理**: 点击后在后台流式请求 AI 润色，界面仅显示 Loading 状态。
    *   **安全预览**: 仅当 AI 成功返回完整结果后，才会弹出编辑器并自动填入润色后的内容。
    *   **无损交互**: 用户可在编辑器中对比确认，满意则保存，取消则原笔记不受任何影响。
*   **异常熔断**: 若 AI 请求失败（网络波动或模型错误），直接提示失败而不弹出编辑器，避免用户面对空白内容不知所措。
