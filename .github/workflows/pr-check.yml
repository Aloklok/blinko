# PR 检查 - 验证依赖更新不破坏构建
# 约 3-5 分钟完成
name: PR Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'package.json'
      - 'bun.lock'
      - 'app/package.json'
      - 'server/package.json'
      - 'shared/package.json'

concurrency:
  group: pr-check-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Validate Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.2.8
      
      - name: Setup Node (for Vite)
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Increase Node.js memory limit
        run: echo "NODE_OPTIONS=--max-old-space-size=4096" >> $GITHUB_ENV
      
      # 安装依赖
      - name: Install Dependencies
        run: bun install --frozen-lockfile
      
      # Turbo 会自动按依赖顺序构建：
      # prisma:generate → build:iconify:icons → app/build:web → server/build:web
      - name: Build (Frontend + Backend)
        run: bun run build:web
